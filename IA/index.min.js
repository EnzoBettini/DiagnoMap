import express from"express";import axios from"axios";import cors from"cors";import dotenv from"dotenv";import path from"path";import{fileURLToPath}from"url";dotenv.config();const app=express();app.use(cors()),app.use(express.json());const __dirname=path.dirname(fileURLToPath(import.meta.url));app.use(express.static(__dirname)),app.get("/",((e,s)=>{s.sendFile(path.join(__dirname,"index.html"))}));const OPENAI_API_KEY=process.env.OPENAI_API_KEY,OPENAI_MODEL=process.env.OPENAI_MODEL;app.post("/analise",(async(e,s)=>{const{dados:o}=e.body;if(!Array.isArray(o))return s.status(400).json({error:"Formato inválido. Envie um array de dados."});const a=`Você é um agente de saúde. Analise os dados abaixo e responda:\n1. Quais doenças estão tendo mais casos?\n2. Quais regiões apresentam mais casos?\n\nDados:\n${JSON.stringify(o,null,2)}\n\nResponda de forma simples e objetiva.`;try{const e=(await axios.post("https://api.openai.com/v1/chat/completions",{model:OPENAI_MODEL,messages:[{role:"user",content:a}]},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${OPENAI_API_KEY}`}})).data.choices?.[0]?.message?.content||"Sem resposta.";s.json({resultado:e})}catch(e){if(e.response&&429===e.response.status)return s.json({resultado:"FAKE: A doença mais frequente é Dengue, principalmente na região Centro. Gripe aparece em Bairro Novo. (resposta simulada)"});s.status(500).json({error:"Erro ao consultar a API OpenAI",details:e.message})}})),app.listen(3001,(()=>{}));